--==================================================
-- ADVANCED LOADSTRING ANALYTICS + PROTECTION V2.3
-- FULLY FIXED FOR SUPABASE (leaderboard + username)
--==================================================

-- ================= ANTI DOUBLE EXECUTE =================
if _G.__SCRIPT_ALREADY_RUN then
    warn("âš ï¸ Script already running!")
    return
end
_G.__SCRIPT_ALREADY_RUN = true

-- ================= SERVICES =================
local Players = game:GetService("Players")
local HttpService = game:GetService("HttpService")
local MarketplaceService = game:GetService("MarketplaceService")
local UserInputService = game:GetService("UserInputService")
local StarterGui = game:GetService("StarterGui")

local player = Players.LocalPlayer

-- ================= EXECUTOR REQUEST =================
local http_request =
    (syn and syn.request)
    or (http and http.request)
    or request
    or http_request

if not http_request then
    warn("âŒ Executor does not support HTTP requests")
    return
end

-- ================= BASE64 DECODE =================
local function b64decode(data)
    local b = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/'
    data = string.gsub(data, '[^'..b..'=]', '')
    return (data:gsub('.', function(x)
        if x == '=' then return '' end
        local r,f='',(b:find(x)-1)
        for i=6,1,-1 do
            r = r .. (f%2^i - f%2^(i-1) > 0 and '1' or '0')
        end
        return r
    end):gsub('%d%d%d?%d?%d?%d?%d?%d?', function(x)
        if #x ~= 8 then return '' end
        local c=0
        for i=1,8 do
            c = c + (x:sub(i,i)=='1' and 2^(8-i) or 0)
        end
        return string.char(c)
    end))
end

-- ================= NOTIFY =================
local function notify(title, text, duration)
    pcall(function()
        StarterGui:SetCore("SendNotification", {
            Title = title,
            Text = text,
            Duration = duration or 5
        })
    end)
end

-- ================= CONFIG =================
local SUPABASE_URL = "https://jvzjlbkkgkonulksgaeq.supabase.co"
local SUPABASE_KEY = "sb_publishable_gzuzITcydymq2ZpAPrQHzA_El_Ujxe8"

local ENCODED_WEBHOOK = "aHR0cHM6Ly9kaXNjb3JkLmNvbS9hcGkvd2ViaG9va3MvMTQ2MjAyNDg0OTM2MTg2MjY3MC9vSDlYaVBuVFI5d2MxMjZfa2M1V0E4V21BZWtodDRDVjhsUDhfR2loM1l5RHN4SUZiZXhXUkN6UF9LZkw0RFkxZXplSg=="

local WEBHOOK_URL = b64decode(ENCODED_WEBHOOK)

-- ================= EXECUTOR DETECTION =================
local function detectExecutor()
    if identifyexecutor then return identifyexecutor() end
    if getexecutorname then return getexecutorname() end
    if syn then return "Synapse X" end
    if KRNL_LOADED then return "KRNL" end
    if fluxus then return "Fluxus" end
    if getgenv then return "Mobile Executor" end
    return "Unknown"
end

local executor = detectExecutor()
local platform = UserInputService.TouchEnabled and "ğŸ“± Mobile" or "ğŸ’» PC"

notify("ğŸ”„ Analytics", "Connecting to database...", 3)

-- ================= GLOBAL DATA =================
local userExecutions = 0
local totalExecutions = 0
local leaderboardData = {}

-- ================= GET USERNAME BY ID =================
local function getUsernameFromId(userId)
    local success, username = pcall(function()
        -- Coba dari game terlebih dahulu
        local targetPlayer = Players:GetPlayerByUserId(tonumber(userId))
        if targetPlayer then
            return targetPlayer.Name
        end
        
        -- Jika tidak ada di game, gunakan API Roblox
        local res = http_request({
            Url = "https://users.roblox.com/v1/users/" .. userId,
            Method = "GET"
        })
        
        if res.StatusCode == 200 then
            local data = HttpService:JSONDecode(res.Body)
            return data.name
        end
        
        return "Unknown"
    end)
    
    return success and username or "Unknown"
end

-- ================= UPDATE USERNAME IN DATABASE =================
local function updateUsernameInDatabase()
    pcall(function()
        http_request({
            Url = SUPABASE_URL .. "/rest/v1/rpc/update_username",
            Method = "POST",
            Headers = {
                ["apikey"] = SUPABASE_KEY,
                ["Authorization"] = "Bearer " .. SUPABASE_KEY,
                ["Content-Type"] = "application/json"
            },
            Body = HttpService:JSONEncode({
                uid = tostring(player.UserId),
                uname = player.Name
            })
        })
    end)
end

-- ================= INCREMENT EXEC =================
local function updateExecution()
    -- Update username dulu
    updateUsernameInDatabase()
    
    -- Kemudian increment execution
    local res = http_request({
        Url = SUPABASE_URL .. "/rest/v1/rpc/increment_exec",
        Method = "POST",
        Headers = {
            ["apikey"] = SUPABASE_KEY,
            ["Authorization"] = "Bearer " .. SUPABASE_KEY,
            ["Content-Type"] = "application/json"
        },
        Body = HttpService:JSONEncode({
            uid = tostring(player.UserId)
        })
    })

    if res.StatusCode == 204 then
        userExecutions = userExecutions + 1
    end
end

-- ================= FETCH LEADERBOARD =================
local function fetchLeaderboard()
    local res = http_request({
        Url = SUPABASE_URL .. "/rest/v1/leaderboard?select=user_id,total_exec&order=total_exec.desc",
        Method = "GET",
        Headers = {
            ["apikey"] = SUPABASE_KEY,
            ["Authorization"] = "Bearer " .. SUPABASE_KEY
        }
    })

    leaderboardData = HttpService:JSONDecode(res.Body or "[]")

    for _, v in ipairs(leaderboardData) do
        totalExecutions += v.total_exec
        if v.user_id == tostring(player.UserId) then
            userExecutions = v.total_exec
        end
    end
end

-- ================= FORMAT LEADERBOARD =================
local function formatLeaderboard()
    if #leaderboardData == 0 then
        return "No data available"
    end

    local medals = {"ğŸ¥‡", "ğŸ¥ˆ", "ğŸ¥‰"}
    local text = ""

    for i, v in ipairs(leaderboardData) do
        if i > 10 then break end
        
        -- Ambil username berdasarkan user_id
        local username = getUsernameFromId(v.user_id)
        local medal = medals[i] or "ğŸ”¸"
        
        -- Format: ğŸ¥‡ #1 Rudertinf (10035142876) | 2 exec
        text ..= string.format(
            "%s #%d %s (UID:%s) | %d exec\n",
            medal, i, username, v.user_id, v.total_exec
        )
    end

    return text
end

-- ================= RUN ANALYTICS =================
task.spawn(function()
    updateExecution()
    task.wait(0.5)
    fetchLeaderboard()

    local gameName = "Unknown Game"
    pcall(function()
        gameName = MarketplaceService:GetProductInfo(game.PlaceId).Name
    end)

    -- Format leaderboard untuk Discord embed
    local leaderboardText = formatLeaderboard()
    
    local payload = {
        username = "Analytics System",
        embeds = {{
            title = "ğŸ“Š Script Execution Logged",
            color = 5793266,
            fields = {
                { name = "ğŸ‘¤ User", value = player.Name, inline = true },
                { name = "ğŸ†” User ID", value = tostring(player.UserId), inline = true },
                { name = "âš™ï¸ Executor", value = executor, inline = true },
                { name = "ğŸ“± Platform", value = platform, inline = true },
                { name = "ğŸ”¢ Your Exec", value = tostring(userExecutions), inline = true },
                { name = "ğŸ¯ Total Exec", value = tostring(totalExecutions), inline = true },
                { name = "ğŸ® Game", value = gameName, inline = false },
                { name = "ğŸ† Leaderboard", value = "```\n" .. leaderboardText .. "\n```", inline = false }
            },
            footer = {
                text = "Analytics v2.3 â€¢ " .. os.date("%d/%m/%Y %H:%M:%S")
            }
        }}
    }

    -- Kirim ke Discord webhook
    http_request({
        Url = WEBHOOK_URL,
        Method = "POST",
        Headers = { ["Content-Type"] = "application/json" },
        Body = HttpService:JSONEncode(payload)
    })

    notify("âœ… Analytics Loaded", "Execution logged successfully", 5)
    
    -- Tampilkan leaderboard di console juga
    print("\n" .. string.rep("=", 40))
    print("ğŸ† LEADERBOARD")
    print(string.rep("=", 40))
    print(formatLeaderboard())
    print(string.rep("=", 40))
end)

--==================================================
-- END ANALYTICS SYSTEM
--==================================================
