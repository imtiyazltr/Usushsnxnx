--==================================================
-- ADVANCED LOADSTRING ANALYTICS + PROTECTION
--==================================================

-- Anti double execute
if _G.__SCRIPT_ALREADY_RUN then return end
_G.__SCRIPT_ALREADY_RUN = true

local Players = game:GetService("Players")
local HttpService = game:GetService("HttpService")
local MarketplaceService = game:GetService("MarketplaceService")
local UserInputService = game:GetService("UserInputService")

local player = Players.LocalPlayer

-- ================= CONFIG =================
local STORAGE_URL = "https://api.npoint.io/7a3d67358b7c6c95e3ad"
local WEBHOOK_URL = "https://discord.com/api/webhooks/1462024849361862670/oH9XiPnTR9wc126_kc5WA8WmAekht4CV8lP8_Gih3YyDsxIFbexWRCzP_KfL4DY1ezeJ"
local SOURCE_ID   = "ujbygKqk" -- pastebin id
-- ==========================================

-- ================= ANTI LEAKER =================
local src = tostring(debug.getinfo(1).source)
if not src:find(SOURCE_ID) then
    warn("Script source mismatch (possible reupload)")
    return
end

-- ================= EXECUTOR DETECTION =================
local function detectExecutor()
    if identifyexecutor then
        return identifyexecutor()
    end
    if getexecutorname then
        return getexecutorname()
    end
    if syn then
        return "Synapse X"
    end
    if KRNL_LOADED then
        return "KRNL"
    end
    if fluxus then
        return "Fluxus"
    end
    if isfile and readfile then
        return "Script-Ware / Delta"
    end
    if getgenv and getrenv then
        return "Mobile Executor"
    end
    return "Unknown / Custom"
end

local executor = detectExecutor()
local platform = UserInputService.TouchEnabled and "Mobile" or "PC"

-- ================= FETCH STORAGE =================
local storage
local ok = pcall(function()
    storage = HttpService:JSONDecode(game:HttpGet(STORAGE_URL))
end)
if not ok or type(storage) ~= "table" then return end

storage.totalExecuted = storage.totalExecuted or 0
storage.users = storage.users or {}
storage.blacklist = storage.blacklist or {}

-- ================= BLACKLIST USER =================
if table.find(storage.blacklist, player.UserId) then
    player:Kick("Access denied")
    return
end

-- ================= UPDATE DATA =================
storage.totalExecuted += 1

local uid = tostring(player.UserId)
storage.users[uid] = storage.users[uid] or {
    username = player.Name,
    count = 0
}

local userData = storage.users[uid]
userData.username = player.Name
userData.count += 1
userData.executor = executor
userData.platform = platform
userData.lastPlaceId = game.PlaceId
userData.lastSeen = os.date("%Y-%m-%d %H:%M:%S")

-- ================= SAVE STORAGE =================
pcall(function()
    HttpService:PostAsync(
        STORAGE_URL,
        HttpService:JSONEncode(storage),
        Enum.HttpContentType.ApplicationJson
    )
end)

-- ================= LEADERBOARD =================
local leaderboard = {}
for _, data in pairs(storage.users) do
    table.insert(leaderboard, data)
end

table.sort(leaderboard, function(a, b)
    return (a.count or 0) > (b.count or 0)
end)

local leaderboardText = ""
for i = 1, math.min(3, #leaderboard) do
    leaderboardText ..= string.format(
        "%d. %s (%dx)\n",
        i,
        leaderboard[i].username,
        leaderboard[i].count
    )
end

-- ================= GAME INFO =================
local gameName = "Unknown"
pcall(function()
    gameName = MarketplaceService:GetProductInfo(game.PlaceId).Name
end)

-- ================= DISCORD LOG =================
local payload = {
    embeds = {{
        title = "ğŸ“Š Script Execution Logged",
        color = 5793266,
        fields = {
            { name = "ğŸ‘¤ User", value = player.Name, inline = true },
            { name = "ğŸ†” UserId", value = tostring(player.UserId), inline = true },
            { name = "âš™ï¸ Executor", value = executor, inline = true },
            { name = "ğŸ’» Platform", value = platform, inline = true },
            { name = "ğŸ® Game", value = gameName, inline = false },
            { name = "ğŸ“ˆ Total Executed", value = tostring(storage.totalExecuted), inline = false },
            { name = "ğŸ† Leaderboard", value = leaderboardText ~= "" and leaderboardText or "No data", inline = false }
        }
    }}
}

pcall(function()
    HttpService:PostAsync(
        WEBHOOK_URL,
        HttpService:JSONEncode(payload),
        Enum.HttpContentType.ApplicationJson
    )
end)

--==================================================
-- END SYSTEM (SCRIPT UTAMA KAMU LANJUT DI BAWAH)
--==================================================
